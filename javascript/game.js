import{cache,eventHandlers}from"./main.js";import{cleanupElements,createGameDisplay}from"./menu.js";export const loadSwf=(file)=>{cleanupElements();cache.mainContainer.style.display="none";createGameDisplay();window.gameRunning=true;const player=window.RufflePlayer.newest().createPlayer();const reader=new FileReader();const cleanup=()=>{reader.onload=null;reader.onerror=null;};reader.onload=(e)=>{const wrapper=document.createElement("div");wrapper.className="game-wrapper";wrapper.style.cssText="position:fixed;top:0;left:0;width:100vw;height:100vh;background:#000!important;display:flex!important;align-items:center!important;justify-content:center!important;z-index:9999;overflow:hidden;pointer-events:auto";const container=document.createElement("div");container.className="game-container";container.style.cssText="position:relative;pointer-events:auto";container.appendChild(player);wrapper.appendChild(container);document.getElementById("game").appendChild(wrapper);player.load({data:e.target.result});player.addEventListener("loadedmetadata",()=>{setTimeout(()=>{const canvas=player.querySelector("canvas");if(canvas)canvas.style.setProperty("pointer-events","auto","important");player.style.setProperty("pointer-events","auto","important");},50);});const escapeHandler=(e)=>{if(e.key==="Escape"){window.gameRunning=false;cleanup();const display=document.getElementById("display");if(display)display.remove();cache.mainContainer.style.display="block";if(cache.gameFileInput)cache.gameFileInput.value="";document.removeEventListener("keydown",escapeHandler);}};document.addEventListener("keydown",escapeHandler);};reader.onerror=cleanup;reader.readAsArrayBuffer(file);};export const setupFileInput=()=>{if(!cache.gameFileInput)return;cache.gameFileInput.addEventListener("change",(e)=>{const file=e.target.files[0];if(file){file.name.split(".").pop().toLowerCase()==="swf"?loadSwf(file):window.loadGame(file);}});};export const setupDragDrop=()=>{const overlay=cache.systemPickerOverlay;let counter=0;if(!overlay||!overlay.querySelector)return;if(!overlay.querySelector(".drop-text")){const text=document.createElement("div");text.className="drop-text";text.textContent="Drop File To Upload";overlay.appendChild(text);}
const prevent=(e)=>{e.preventDefault();e.stopPropagation();};const drop=(e)=>{prevent(e);counter=0;if(overlay)overlay.classList.remove("drag-active");const file=e.dataTransfer.files[0];if(!file||!cache.gameFileInput)return;const dt=new DataTransfer();dt.items.add(file);cache.gameFileInput.files=dt.files;cache.gameFileInput.dispatchEvent(new Event("change",{bubbles:true}));};const dragenter=(e)=>{prevent(e);if(++counter===1){requestAnimationFrame(()=>overlay&&overlay.classList.add("drag-active"));}};const dragleave=(e)=>{prevent(e);if(--counter===0){requestAnimationFrame(()=>overlay&&overlay.classList.remove("drag-active"));}};eventHandlers.dragHandlers={prevent,drop,dragenter,dragleave};const events=["dragenter","dragover","dragleave","drop"];events.forEach((evt)=>{document.addEventListener(evt,prevent);cache.mainContainer?.addEventListener(evt,prevent);});document.addEventListener("dragenter",dragenter);document.addEventListener("dragleave",dragleave);document.addEventListener("drop",drop);cache.mainContainer?.addEventListener("drop",drop);};