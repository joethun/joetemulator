import{log,LOG_TYPE}from"./logger.js";import*as Sfx from"./sfx.js";import{cache,state,eventHandlers,getActiveMenu,DIR,TRANSITION_MS,H_MOVE_PCT,V_MOVE_VH,V_OFFSET_VH,RESIZE_DEBOUNCE_MS,}from"./main.js";export let resizeTimer;export const stopResizeTimer=()=>{clearTimeout(resizeTimer);resizeTimer=null;};const waitTransitions=(els)=>new Promise((resolve)=>{if(!els.length){resolve();return;}
const timeout=setTimeout(()=>{cleanup();resolve();},TRANSITION_MS);const handler=(e)=>{if(e.propertyName==="transform"){clearTimeout(timeout);cleanup();resolve();}};const cleanup=()=>els[0].removeEventListener("transitionend",handler);els[0].addEventListener("transitionend",handler);});export const initCache=()=>{cache.menuItems=document.querySelectorAll(".menu-item");cache.mainContainer=document.querySelector(".main-container");cache.statusBar=document.querySelector(".status-bar");cache.systemPickerOverlay=document.getElementById("system-picker-overlay");cache.systemPicker=document.getElementById("system-picker");cache.systemsWrapper=document.getElementById("systems-wrapper");cache.systemsContainer=document.getElementById("systems-container");cache.gameFileInput=document.getElementById("gameFileInput");cache.activeMenuDisplay=document.querySelector("#active-menu-item-index-display");cache.activeSubMenuDisplay=document.querySelector("#active-sub-menu-item-index-display");};export const buildMenuData=()=>{cache.menuItems.forEach((el,idx)=>{const container=el.querySelector(".sub-menu-item-container");const subMenuItems=container?[...container.children]:[];const subItemData=subMenuItems.map(()=>({move:0,offset:0}));state.menuData.push({subMenuItemCount:container?subMenuItems.length:-1,menuItemIndex:idx,activeSubMenuItemIndex:0,subMenuItemContainer:container,subMenuItems,subItemData,});});};export const toggleTransitions=(enable)=>{const elements=document.querySelectorAll(".menu-item, .sub-menu-item");requestAnimationFrame(()=>{elements.forEach((el)=>{el.style.transition=enable?"":"none";});});};export const recalculatePositions=()=>{requestAnimationFrame(()=>{const targetTranslateVw=state.activeMenuIdx*(H_MOVE_PCT*100)*-1;const transformValue=`translateX(${targetTranslateVw}vw)`;cache.menuItems.forEach((el)=>{el.style.transform=transformValue;});state.menuData.forEach((menu)=>{if(menu.subMenuItemContainer&&menu.subItemData.length>0){menu.subMenuItems.forEach((el,idx)=>{const itemData=menu.subItemData[idx];el.style.setProperty("--vertical-movement",`${itemData.move}vh`);el.style.setProperty("--vertical-offset",`${itemData.offset}vh`);});}});});};export const cleanupElements=()=>{["system-picker","system-picker-overlay","top","version"].forEach((id)=>{const el=document.getElementById(id);if(el)el.remove();});};export const createGameDisplay=()=>{const d=document.createElement("div");d.id="display";d.style.cssText="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:9999;background:#000;display:flex;align-items:center;justify-content:center;overflow:hidden;pointer-events:auto";d.innerHTML='<div id="game" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;pointer-events:auto"></div>';document.body.appendChild(d);return d;};export const queueAction=(action)=>{if(!state.actionQueue.some((a)=>a.type===action.type&&a.dir===action.dir)){state.actionQueue.push(action);}
if(!state.processing)processQueue();};export const processQueue=async()=>{if(!state.actionQueue.length){state.processing=false;return;}
state.processing=true;const{dir,type}=state.actionQueue.shift();await(type==="h"?moveHorizontal(dir):moveVertical(dir));processQueue();};const moveHorizontal=async(dir)=>{const canMove=!state.hTransitioning&&(dir===DIR.Right?state.activeMenuIdx<state.menuData.length-1:state.activeMenuIdx>0);if(!canMove){log(LOG_TYPE.WARNING,state.hTransitioning?"Transitioning":"Cannot move");return;}
if(resizeTimer){stopResizeTimer();recalculatePositions();toggleTransitions(true);}
state.hTransitioning=true;const prevIdx=state.activeMenuIdx;state.activeMenuIdx+=dir;const targetTranslateVw=state.activeMenuIdx*(H_MOVE_PCT*100)*-1;const transformValue=`translateX(${targetTranslateVw}vw)`;requestAnimationFrame(()=>{cache.menuItems[prevIdx].classList.remove("active-menu-item");cache.menuItems[state.activeMenuIdx].classList.add("active-menu-item");cache.menuItems.forEach((el)=>{el.style.transform=transformValue;});});await Sfx.playClick();await waitTransitions([...cache.menuItems]);state.hTransitioning=false;};const moveVertical=async(dir)=>{const menu=getActiveMenu();const canMove=menu.subMenuItemCount!==-1&&!state.vTransitioning&&(dir===DIR.Down?menu.activeSubMenuItemIndex<menu.subMenuItemCount-1:menu.activeSubMenuItemIndex>0);if(!canMove){log(LOG_TYPE.WARNING,menu.subMenuItemCount===-1?"No submenu":"Cannot move");return;}
state.vTransitioning=true;const prevIdx=menu.activeSubMenuItemIndex;menu.activeSubMenuItemIndex+=dir===DIR.Down?1:-1;const items=menu.subMenuItems;const updates=items.map((el,idx)=>{const itemData=menu.subItemData[idx];const isActive=idx===menu.activeSubMenuItemIndex;itemData.move+=V_MOVE_VH*dir;const verticalMovement=`${itemData.move}vh`;let verticalOffset=`${itemData.offset}vh`;if((dir===DIR.Down&&idx===prevIdx)||(dir===DIR.Up&&idx===prevIdx-1)){itemData.offset+=V_OFFSET_VH*dir;verticalOffset=`${itemData.offset}vh`;}
return{el,isActive,verticalMovement,verticalOffset};});requestAnimationFrame(()=>{const prevActive=items[prevIdx];const newActive=items[menu.activeSubMenuItemIndex];prevActive.classList.remove("active-sub-menu-item");newActive.classList.add("active-sub-menu-item");updates.forEach(({el,verticalMovement,verticalOffset})=>{el.style.setProperty("--vertical-movement",verticalMovement);el.style.setProperty("--vertical-offset",verticalOffset);});});await Sfx.playClick();await waitTransitions(items);state.vTransitioning=false;};const updatePickerSelection=()=>{requestAnimationFrame(()=>{state.picker.items.forEach((item,idx)=>{if(idx===state.picker.activeIdx){item.element.classList.add("active-system-item");}else{item.element.classList.remove("active-system-item");}});});};const scrollToPicker=()=>{if(!cache.systemsContainer)return;const item=state.picker.items[state.picker.activeIdx];if(!item)return;item.element.scrollIntoView({behavior:"smooth",block:"center"});};export const showPicker=(systems,resolve)=>{state.picker={active:true,items:[],activeIdx:0};cache.systemsWrapper.innerHTML="";const fragment=document.createDocumentFragment();Object.entries(systems).forEach(([name,value])=>{const item=document.createElement("div");item.className="system-list-item";item.innerHTML=`<div class="system-list-item-header">${name}</div>`;fragment.appendChild(item);state.picker.items.push({element:item,value,name});});cache.systemsWrapper.appendChild(fragment);cache.systemPickerOverlay.classList.add("active");cache.systemPicker.classList.remove("show");cache.systemPicker.offsetWidth;cache.systemPicker.classList.add("show");updatePickerSelection();window.systemPickerResolve=resolve;};export const hidePicker=()=>{cache.systemPickerOverlay.classList.remove("active");state.picker.active=false;};export const navPicker=(dir)=>{if(!state.picker.active)return;const newIdx=state.picker.activeIdx+(dir===DIR.Down?1:-1);if(newIdx>=0&&newIdx<state.picker.items.length){state.picker.activeIdx=newIdx;updatePickerSelection();scrollToPicker();Sfx.playClick();}};export const enterPicker=()=>{if(!state.picker.active)return;hidePicker();window.systemPickerResolve(state.picker.items[state.picker.activeIdx].value);};export const handleKey=(e)=>{const keyMap={ArrowLeft:{dir:DIR.Left,type:"h"},a:{dir:DIR.Left,type:"h"},A:{dir:DIR.Left,type:"h"},ArrowRight:{dir:DIR.Right,type:"h"},d:{dir:DIR.Right,type:"h"},D:{dir:DIR.Right,type:"h"},ArrowUp:{dir:DIR.Up,type:"v"},w:{dir:DIR.Up,type:"v"},W:{dir:DIR.Up,type:"v"},ArrowDown:{dir:DIR.Down,type:"v"},s:{dir:DIR.Down,type:"v"},S:{dir:DIR.Down,type:"v"},};if(state.picker.active){if(["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Enter"].includes(e.key))
e.preventDefault();if(["ArrowUp","w","W"].includes(e.key))navPicker(DIR.Up);else if(["ArrowDown","s","S"].includes(e.key))navPicker(DIR.Down);else if(e.key==="Enter")enterPicker();return;}
if(window.gameRunning)return;if(["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].includes(e.key))
e.preventDefault();if(keyMap[e.key]){queueAction(keyMap[e.key]);}else if(e.key==="t"){state.statusVisible=!state.statusVisible;cache.statusBar.style.display=state.statusVisible?"block":"none";}else if(e.key==="Enter"){const menu=getActiveMenu();if(state.activeMenuIdx===0&&menu.activeSubMenuItemIndex===0&&!window.gameRunning){cache.gameFileInput?.click();}else if(state.activeMenuIdx===1){const urls=["https://github.com/joethun/joetemulator","https://github.com/joethun/joetemulator/wiki/Changelog",];if(menu.activeSubMenuItemIndex<2)
window.open(urls[menu.activeSubMenuItemIndex],"_blank");}}
if(cache.activeMenuDisplay&&cache.activeSubMenuDisplay){requestAnimationFrame(()=>{cache.activeMenuDisplay.textContent=state.activeMenuIdx;cache.activeSubMenuDisplay.textContent=getActiveMenu().activeSubMenuItemIndex;});}};export const handleResize=()=>{toggleTransitions(false);clearTimeout(resizeTimer);resizeTimer=setTimeout(()=>{recalculatePositions();toggleTransitions(true);resizeTimer=null;},RESIZE_DEBOUNCE_MS);};